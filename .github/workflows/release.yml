name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Optional version override (default: UTC date %Y.%m.%j%H%M)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest
    env:
      HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select latest stable Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Toolchain versions
        shell: bash
        run: |
          set -euo pipefail
          xcodebuild -version
          xcrun --sdk macosx --show-sdk-version
          swift --version

      - name: Generate version
        id: version
        shell: bash
        run: |
          set -euo pipefail
          if [[ -n "${{ inputs.version }}" ]]; then
            tag="${{ inputs.version }}"
          else
            tag="$(date -u '+%Y.%m.%j%H%M')"
          fi
          echo "tag=${tag}" >> "$GITHUB_OUTPUT"

      - name: Install SwiftFormat
        run: brew install swiftformat

      - name: Format check and tests
        run: bash scripts/check.sh

      - name: Build distributable
        run: bash build.sh "${{ steps.version.outputs.tag }}"

      - name: Verify bundle metadata
        shell: bash
        run: |
          set -euo pipefail
          plist="build/Sentrio.app/Contents/Info.plist"
          v="$(/usr/libexec/PlistBuddy -c 'Print :CFBundleShortVersionString' "${plist}")"
          b="$(/usr/libexec/PlistBuddy -c 'Print :CFBundleVersion' "${plist}")"
          [[ "${v}" == "${{ steps.version.outputs.tag }}" ]]
          [[ "${b}" == "${{ steps.version.outputs.tag }}" ]]

      - name: Verify universal binary
        shell: bash
        run: |
          set -euo pipefail
          bin="build/Sentrio.app/Contents/MacOS/Sentrio"
          lipo -info "${bin}"
          lipo -info "${bin}" | grep -q "arm64"
          lipo -info "${bin}" | grep -q "x86_64"

      - name: Verify code signature
        run: codesign --verify --deep --verbose=2 build/Sentrio.app

      - name: Zip app bundle
        run: |
          cd build
          zip -r --symlinks "Sentrio-${{ steps.version.outputs.tag }}.zip" Sentrio.app

      - name: Compute SHA256 (for Homebrew)
        id: sha
        shell: bash
        run: |
          set -euo pipefail
          zip="build/Sentrio-${{ steps.version.outputs.tag }}.zip"
          sha="$(shasum -a 256 "${zip}" | awk '{print $1}')"
          echo "sha=${sha}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Sentrio ${{ steps.version.outputs.tag }}
          body: |
            Automated build from ${{ github.sha }}.

            **Install:** download the zip, unzip, drag `Sentrio.app` to `/Applications`, then right-click â†’ **Open** on first launch (not notarized).
          files: build/Sentrio-${{ steps.version.outputs.tag }}.zip
          draft: false
          prerelease: false

      - name: Checkout Homebrew tap
        if: ${{ env.HOMEBREW_TAP_TOKEN != '' }}
        uses: actions/checkout@v4
        with:
          repository: YunaBraska/homebrew-tap
          token: ${{ env.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update Homebrew cask
        if: ${{ env.HOMEBREW_TAP_TOKEN != '' }}
        shell: bash
        run: |
          set -euo pipefail
          version="${{ steps.version.outputs.tag }}"
          sha="${{ steps.sha.outputs.sha }}"

          cask="homebrew-tap/Casks/sentrio.rb"
          mkdir -p "$(dirname "${cask}")"
          cat > "${cask}" <<EOF
          cask "sentrio" do
            version "${version}"
            sha256 "${sha}"

            url "https://github.com/YunaBraska/Sentrio/releases/download/#{version}/Sentrio-#{version}.zip",
                verified: "github.com/YunaBraska/Sentrio/"
            name "Sentrio"
            desc "macOS menu bar app that auto-switches audio devices"
            homepage "https://github.com/YunaBraska/Sentrio"

            depends_on macos: ">= :ventura"

            app "Sentrio.app"
          end
          EOF

          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Casks/sentrio.rb
          if git diff --cached --quiet; then
            echo "Homebrew cask already up to date."
            exit 0
          fi
          git commit -m "sentrio: ${version}"
          git push
